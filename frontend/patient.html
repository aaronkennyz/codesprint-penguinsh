<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="manifest" href="/manifest.json"/>
  <link rel="stylesheet" href="/assets/styles.css"/>
  <title>Patient</title>
</head>
<body>
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="brand-mark"></div>
      <div>
        <h1>Patient</h1>
        <div class="subtitle">Your presence code</div>
      </div>
    </div>
    <div class="row" style="gap:8px">
      <a class="btn ghost" href="/login.html">Back</a>
    </div>
  </div>
</div>

<div class="container">
  <div class="grid grid-2">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">6-digit presence code</h2>
        <span class="badge" data-sync>⏳</span>
      </div>
      <div id="code" class="code">------</div>
      <p class="small">Tell this code to the clinic worker for verification.</p>
    </div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Upcoming camps (demo)</h2>
      </div>
      <div id="camps" class="list"></div>
    </div>
  </div>
</div>

<script type="module">
  import "./js/app.js";
  import { setSyncBadge, toast } from "./js/ui.js";
  import { api } from "./js/api.js";

  setSyncBadge(navigator.onLine ? "✅ Online" : "⚠️ Offline", navigator.onLine ? "ok":"bad");

  function genDemo6() {
    return String(Math.floor(Math.random()*1e6)).padStart(6,"0");
  }

  let current = "------";
  function tick() {
    current = genDemo6();
    document.querySelector("#code").textContent = current;
  }
  tick();
  setInterval(tick, 30_000);

  async function loadCamps() {
    if (!navigator.onLine) return;
    const rows = await api("/api/camps?village_id=1&from_date=" + new Date().toISOString().slice(0,10));
    const box = document.querySelector("#camps");
    box.innerHTML = "";
    for (const c of rows) {
      const div = document.createElement("div");
      div.className="item";
      const maps = `https://www.google.com/maps?q=${c.lat},${c.lng}`;
      div.innerHTML = `<div class="item-title">${c.name} • ${c.date}</div>
        <div class="small">${c.address||""} ${c.landmark?(" • "+c.landmark):""}</div>
        <div class="small"><a href="${maps}" target="_blank" rel="noopener">Open in Maps</a> • ${c.contact_name||""} ${c.contact_phone||""}</div>`;
      box.appendChild(div);
    }
  }
  loadCamps().catch(e=>toast(e.message));
</script>
</body>
</html>
