<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="manifest" href="/manifest.json"/>
  <link rel="stylesheet" href="/assets/styles.css"/>
  <title>Screener</title>
</head>
<body class="page page-screener">
<header>
  <div class="page-title"><span class="dot"></span><h1>Screener</h1></div>
  <div class="subtitle">Quick capture • Offline-friendly</div>
</header>
<main class="stack">
  <div class="card">
    <div class="badge" data-sync>⏳</div>
    <div class="row">
      <div class="col"><label>Person ID</label><input id="personId" inputmode="numeric"></div>
      <div class="col"><label>Camp ID (optional)</label><input id="campId" inputmode="numeric"></div>
    </div>
    <button id="start" class="secondary">Start Encounter</button>
    <p class="small">If offline, this will be queued and synced later.</p>
  </div>

  <div class="card" id="verifyBox" style="display:none">
    <h2>Presence Verification</h2>
    <video id="video" playsinline></video>
    <div class="row">
      <div class="col"><label>6-digit Code</label><input id="code" class="code" inputmode="numeric" maxlength="6"></div>
      <div class="col"><label>&nbsp;</label><button id="scan" class="secondary">Scan QR</button></div>
    </div>
    <button id="verify">Verify (online)</button>
    <p class="small">Offline? Skip verification → submit as <b>UNVERIFIED</b> (clinician approves later).</p>
  </div>

  <div class="card" id="formBox" style="display:none">
    <h2>Vitals</h2>
    <div class="grid2">
      <div><label>SBP #1</label><input id="sbp1" inputmode="numeric"></div>
      <div><label>DBP #1</label><input id="dbp1" inputmode="numeric"></div>
      <div><label>SBP #2</label><input id="sbp2" inputmode="numeric"></div>
      <div><label>DBP #2</label><input id="dbp2" inputmode="numeric"></div>
      <div><label>HR</label><input id="hr" inputmode="numeric"></div>
      <div><label>SpO2</label><input id="spo2" inputmode="numeric"></div>
      <div><label>Temp (°C)</label><input id="temp" inputmode="decimal"></div>
      <div><label>Weight (kg)</label><input id="weight" inputmode="decimal"></div>
      <div><label>Height (m)</label><input id="height" inputmode="decimal"></div>
      <div><label>Waist (cm)</label><input id="waist" inputmode="decimal"></div>
    </div>
    <hr/>
    <h2>Tests</h2>
    <div class="row">
      <div class="col"><label>Glucose Type</label>
        <select id="gtype"><option value="">—</option><option>FASTING</option><option>RANDOM</option></select>
      </div>
      <div class="col"><label>Glucose Value</label><input id="gval" inputmode="numeric"></div>
    </div>

    <button id="submit">Submit Encounter</button>
    <p class="small" id="statusLine"></p>
  </div>
</main>

<script type="module">
  import "./js/app.js";
  import { enqueue } from "./js/outbox.js";
  import { safeApi } from "./js/api.js";
  import { toast, setSyncBadge } from "./js/ui.js";
  import { computeDerived } from "./js/triage.js";
  import { loadRules } from "./js/rules.js";
  import { startCamera } from "./js/camera.js";
  import { scanQrFromVideo } from "./js/qr.js";

  setSyncBadge(navigator.onLine ? "✅ Online" : "⚠️ Offline", navigator.onLine ? "ok":"bad");

  let encounterId = null;
  let verificationToken = null;
  let stopCam = null;
  let stopScan = null;

  async function startEncounter() {
    const person_id = +document.querySelector("#personId").value;
    const camp_id = document.querySelector("#campId").value ? +document.querySelector("#campId").value : null;
    const payload = { person_id, camp_id, client_created_at: new Date().toISOString() };

    if (navigator.onLine) {
      const res = await safeApi("/api/encounters/start", { method:"POST", body: payload });
      if (res.ok) { encounterId = res.data.encounter_id; toast("Encounter started"); }
      else { await enqueue("encounter:start", payload); toast("Saved offline: start encounter"); encounterId = "OFFLINE_LOCAL"; }
    } else {
      await enqueue("encounter:start", payload);
      encounterId = "OFFLINE_LOCAL";
      toast("Saved offline: start encounter");
    }

    document.querySelector("#verifyBox").style.display = "";
    document.querySelector("#formBox").style.display = "";
  }

  async function scanQR() {
    const video = document.querySelector("#video");
    stopCam = await startCamera(video);
    try {
      stopScan = await scanQrFromVideo(video, (raw) => {
        // spec: QR encodes ONLY 6 digits
        const digits = raw.replace(/\D/g,"").slice(0,6);
        document.querySelector("#code").value = digits;
        toast("QR captured");
        stopScan?.(); stopCam?.();
      });
    } catch (e) {
      toast(e.message);
      stopCam?.();
    }
  }

  async function verifyOnline() {
    if (!navigator.onLine || encounterId === "OFFLINE_LOCAL") {
      toast("Offline: cannot verify. Submit as UNVERIFIED.");
      return;
    }
    const person_id = +document.querySelector("#personId").value;
    const code = document.querySelector("#code").value.trim();
    const res = await safeApi("/api/verify-totp", { method:"POST", body: { person_id, encounter_id: encounterId, code, client_time: new Date().toISOString() }});
    if (res.ok) {
      verificationToken = res.data.verification_token;
      toast("Verified (token issued)");
    } else {
      toast("Verify failed: " + res.error);
    }
  }

  function num(id){ const v=document.querySelector(id).value.trim(); return v===""?null:+v; }
  function dec(id){ const v=document.querySelector(id).value.trim(); return v===""?null:+v; }

  async function submitEncounter() {
    const rules = await loadRules();
    const vitals = {
      sbp1:num("#sbp1"), dbp1:num("#dbp1"), sbp2:num("#sbp2"), dbp2:num("#dbp2"),
      hr:num("#hr"), spo2:num("#spo2"), temp:dec("#temp"),
      weight:dec("#weight"), height:dec("#height"), waist:dec("#waist"),
      consent:true
    };
    const tests = { glucose_type: document.querySelector("#gtype").value || null, glucose_value: num("#gval") };

    const derived = await computeDerived({ ...vitals, ...tests, overdue_days:0, missed_followups:0 });

    const body = { vitals, tests, rules_version: rules.meta.version, derived, verification_token: verificationToken, client_submitted_at: new Date().toISOString() };

    if (navigator.onLine && encounterId !== "OFFLINE_LOCAL") {
      const res = await safeApi(`/api/encounters/${encounterId}/submit`, { method:"POST", body });
      if (res.ok) {
        toast(`Submitted: ${res.data.status} • ${res.data.rag}`);
      } else {
        // if submission fails, queue it
        await enqueue("encounter:submit", { encounter_id: encounterId, body });
        toast("Saved offline: submit encounter");
      }
    } else {
      await enqueue("encounter:submit", { encounter_id: encounterId, body });
      toast("Saved offline: submit encounter (UNVERIFIED until clinician)");
    }
  }

  document.querySelector("#start").onclick = () => startEncounter().catch(e=>toast(e.message));
  document.querySelector("#scan").onclick = () => scanQR().catch(e=>toast(e.message));
  document.querySelector("#verify").onclick = () => verifyOnline().catch(e=>toast(e.message));
  document.querySelector("#submit").onclick = () => submitEncounter().catch(e=>toast(e.message));
</script>
</body>
</html>
