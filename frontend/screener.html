<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="manifest" href="/manifest.json"/>
  <link rel="stylesheet" href="/assets/styles.css"/>
  <title>Screener</title>
</head>
<body>
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="brand-mark"></div>
      <div>
        <h1>Screener</h1>
        <div class="subtitle">Clinical screening capture</div>
      </div>
    </div>
    <div class="row" style="gap:8px">
      <a class="btn ghost" href="/login.html">Back</a>
      <a class="btn ghost" href="/offline.html">Diagnostics</a>
    </div>
  </div>
</div>

<div class="container">
  <div class="grid grid-2">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Start encounter</h2>
        <span class="badge" data-sync>⏳</span>
      </div>
      <div class="row">
        <div class="col">
          <label>Person ID</label>
          <input id="personId" inputmode="numeric" placeholder="e.g. 1">
        </div>
        <div class="col">
          <label>Camp ID (optional)</label>
          <input id="campId" inputmode="numeric" placeholder="e.g. 3">
        </div>
      </div>
      <div class="actions">
        <button id="start" class="btn secondary">Start Encounter</button>
      </div>
      <p class="small">If offline, this will be queued and synced later.</p>
    </div>

    <div class="card soft" id="verifyBox" style="display:none">
      <div class="card-header">
        <h2 class="card-title">Presence verification</h2>
      </div>
      <label>6-digit TOTP</label>
      <input id="code" class="code" inputmode="numeric" maxlength="6" placeholder="123456">
      <div class="actions">
        <button id="verify" class="btn">Verify (online)</button>
      </div>
      <p class="small">Ask the patient for their 6-digit code. Offline? submit as UNVERIFIED.</p>
    </div>

    <div class="card" id="formBox" style="display:none">
      <div class="card-header">
        <h2 class="card-title">Vitals</h2>
      </div>
      <div class="grid grid-2">
        <div><label>SBP #1</label><input id="sbp1" inputmode="numeric"></div>
        <div><label>DBP #1</label><input id="dbp1" inputmode="numeric"></div>
        <div><label>SBP #2</label><input id="sbp2" inputmode="numeric"></div>
        <div><label>DBP #2</label><input id="dbp2" inputmode="numeric"></div>
        <div><label>HR</label><input id="hr" inputmode="numeric"></div>
        <div><label>SpO2</label><input id="spo2" inputmode="numeric"></div>
        <div><label>Temp (°C)</label><input id="temp" inputmode="decimal"></div>
        <div><label>Weight (kg)</label><input id="weight" inputmode="decimal"></div>
        <div><label>Height (m)</label><input id="height" inputmode="decimal"></div>
        <div><label>Waist (cm)</label><input id="waist" inputmode="decimal"></div>
      </div>
      <div class="hr"></div>
      <div class="card-header">
        <h2 class="card-title">Tests</h2>
      </div>
      <div class="row">
        <div class="col">
          <label>Glucose Type</label>
          <select id="gtype"><option value="">—</option><option>FASTING</option><option>RANDOM</option></select>
        </div>
        <div class="col">
          <label>Glucose Value</label>
          <input id="gval" inputmode="numeric">
        </div>
      </div>
      <div class="actions">
        <button id="submit" class="btn">Submit Encounter</button>
      </div>
      <p class="small" id="statusLine"></p>
    </div>
  </div>
</div>

<script type="module">
  import "./js/app.js";
  import { enqueue } from "./js/outbox.js";
  import { safeApi } from "./js/api.js";
  import { toast, setSyncBadge } from "./js/ui.js";
  import { computeDerived } from "./js/triage.js";
  import { loadRules } from "./js/rules.js";

  setSyncBadge(navigator.onLine ? "✅ Online" : "⚠️ Offline", navigator.onLine ? "ok":"bad");

  let encounterId = null;
  let verificationToken = null;

  function num(id){ const v=document.querySelector(id).value.trim(); return v===""?null:+v; }
  function dec(id){ const v=document.querySelector(id).value.trim(); return v===""?null:+v; }

  async function startEncounter() {
    const personRaw = document.querySelector("#personId").value.trim();
    const campRaw = document.querySelector("#campId").value.trim();
    const person_id = personRaw ? Number(personRaw) : null;
    const camp_id = campRaw ? Number(campRaw) : null;
    if (!person_id || Number.isNaN(person_id)) {
      toast("Enter a valid Person ID before starting.");
      return;
    }
    if (camp_id !== null && Number.isNaN(camp_id)) {
      toast("Camp ID must be a number.");
      return;
    }

    const payload = { person_id, camp_id, client_created_at: new Date().toISOString() };

    if (navigator.onLine) {
      const res = await safeApi("/api/encounters/start", { method:"POST", body: payload });
      if (res.ok) {
        encounterId = res.data.encounter_id;
        toast("Encounter started");
      } else {
        toast("Start failed: " + res.error);
        return;
      }
    } else {
      await enqueue("encounter:start", payload);
      encounterId = "OFFLINE_LOCAL";
      toast("Saved offline: start encounter");
    }

    document.querySelector("#verifyBox").style.display = "";
    document.querySelector("#formBox").style.display = "";
  }

  async function verifyOnline() {
    if (!navigator.onLine || encounterId === "OFFLINE_LOCAL") {
      toast("Offline: cannot verify. Submit as UNVERIFIED.");
      return;
    }
    const person_id = +document.querySelector("#personId").value;
    const code = document.querySelector("#code").value.trim();
    const res = await safeApi("/api/verify-totp", { method:"POST", body: { person_id, encounter_id: encounterId, code, client_time: new Date().toISOString() }});
    if (res.ok) {
      verificationToken = res.data.verification_token;
      toast("Verified (token issued)");
    } else {
      toast("Verify failed: " + res.error);
    }
  }

  async function submitEncounter() {
    const rules = await loadRules();
    const vitals = {
      sbp1:num("#sbp1"), dbp1:num("#dbp1"), sbp2:num("#sbp2"), dbp2:num("#dbp2"),
      hr:num("#hr"), spo2:num("#spo2"), temp:dec("#temp"),
      weight:dec("#weight"), height:dec("#height"), waist:dec("#waist"),
      consent:true
    };
    const tests = { glucose_type: document.querySelector("#gtype").value || null, glucose_value: num("#gval") };
    const derived = await computeDerived({ ...vitals, ...tests, overdue_days:0, missed_followups:0 });
    const body = { vitals, tests, rules_version: rules.meta.version, derived, verification_token: verificationToken, client_submitted_at: new Date().toISOString() };

    if (navigator.onLine && encounterId !== "OFFLINE_LOCAL") {
      const res = await safeApi(`/api/encounters/${encounterId}/submit`, { method:"POST", body });
      if (res.ok) {
        toast(`Submitted: ${res.data.status} • ${res.data.rag}`);
      } else {
        await enqueue("encounter:submit", { encounter_id: encounterId, body });
        toast("Saved offline: submit encounter");
      }
    } else {
      await enqueue("encounter:submit", { encounter_id: encounterId, body });
      toast("Saved offline: submit encounter (UNVERIFIED until clinician)");
    }
  }

  document.querySelector("#start").onclick = () => startEncounter().catch(e=>toast(e.message));
  document.querySelector("#verify").onclick = () => verifyOnline().catch(e=>toast(e.message));
  document.querySelector("#submit").onclick = () => submitEncounter().catch(e=>toast(e.message));
</script>
</body>
</html>
