<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Offline Diagnostics | RuralReach</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/assets/styles.css">
  <meta name="theme-color" content="#ffffff">
</head>
<body>
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="brand-mark"></div>
      <div>
        <h1>Offline Diagnostics</h1>
        <div class="subtitle">Use this to clear cache and storage</div>
      </div>
    </div>
    <div class="row" style="gap:8px">
      <a class="btn ghost" href="/login.html">Back</a>
    </div>
  </div>
</div>

<div class="container">
  <div class="grid grid-2">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Connection</h2>
      </div>
      <div class="row">
        <span class="badge" id="netPill">⏳</span>
        <span class="badge" id="swPill">⏳</span>
      </div>
      <div class="actions">
        <button id="clearBtn" class="btn">Clear site data + unregister Service Worker</button>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Current storage</h2>
      </div>
      <pre id="out"></pre>
    </div>
  </div>
</div>

<script>
  function setNet(){ document.getElementById("netPill").textContent = navigator.onLine ? "Online" : "Offline"; }
  addEventListener("online",setNet); addEventListener("offline",setNet); setNet();

  async function swStatus(){
    const el = document.getElementById("swPill");
    if (!("serviceWorker" in navigator)) { el.textContent="SW: not supported"; return; }
    const regs = await navigator.serviceWorker.getRegistrations();
    el.textContent = regs.length ? `SW: ${regs.length} registered` : "SW: none";
  }
  swStatus();

  document.getElementById("clearBtn").onclick = async () => {
    try{
      if ("serviceWorker" in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        for (const r of regs) await r.unregister();
      }
      if ("caches" in window) {
        const keys = await caches.keys();
        for (const k of keys) await caches.delete(k);
      }
      localStorage.clear(); sessionStorage.clear();
      if (indexedDB.databases) {
        const dbs = await indexedDB.databases();
        for (const db of dbs) { if (db.name) indexedDB.deleteDatabase(db.name); }
      }
      alert("Cleared. Now hard refresh (Ctrl+Shift+R) and login again.");
      await swStatus();
      dump();
    } catch(e){
      alert("Clear failed: " + e.message);
    }
  };

  async function dump(){
    const out = document.getElementById("out");
    const info = {
      online: navigator.onLine,
      origin: location.origin,
      token_present: !!localStorage.getItem("rh_token"),
      api_base: localStorage.getItem("API_BASE") || "http://127.0.0.1:8000",
      sw_supported: "serviceWorker" in navigator,
      caches_supported: "caches" in window,
      idb_databases_supported: !!indexedDB.databases
    };
    out.textContent = JSON.stringify(info, null, 2);
  }
  dump();
</script>
</body>
</html>
