<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clinician | RuralReach</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/assets/styles.css">
  <meta name="theme-color" content="#ffffff">
</head>
<body>
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="brand-mark"></div>
      <div>
        <h1>Clinician</h1>
        <div class="subtitle" id="meLine">Checking session...</div>
      </div>
    </div>
    <div class="row" style="gap:8px">
      <span class="badge" id="netPill">⏳</span>
      <a class="btn ghost" href="/login.html">Back</a>
      <button class="btn secondary" id="logoutBtn">Logout</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="grid grid-2">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Queue (Amber/Red)</h2>
      </div>
      <div class="row">
        <select id="rag">
          <option value="RED">RED</option>
          <option value="AMBER">AMBER</option>
        </select>
        <button id="loadQueueBtn" class="btn secondary">Load queue</button>
      </div>
      <div class="list" id="queueList"></div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Unverified encounters</h2>
      </div>
      <div class="actions">
        <button id="loadUnverifiedBtn" class="btn secondary">Load unverified</button>
      </div>
      <div class="list" id="unvList"></div>
    </div>
  </div>
</div>

<script type="module">
  import "./js/app.js";
  import { api } from "./js/api.js";
  import { getToken, clearToken } from "./js/auth.js";

  function setNetPill(){document.getElementById("netPill").textContent=navigator.onLine?"Online":"Offline";}
  addEventListener("online",setNetPill); addEventListener("offline",setNetPill); setNetPill();

  function requireAuth(){ if(!getToken()) location.href="/login.html"; }
  async function loadMe(){
    try{
      const me = await api("/api/me");
      const name = me.display_name || (me.worker_id ? `Worker ${me.worker_id}` : "User");
      document.getElementById("meLine").textContent=`${me.role} - ${name}`;
    }
    catch{ document.getElementById("meLine").textContent="Session invalid - please login"; }
  }
  document.getElementById("logoutBtn").onclick=()=>{ clearToken(); location.href="/login.html"; };

  document.getElementById("loadQueueBtn").onclick = async () => {
    const rag = document.getElementById("rag").value;
    const list = document.getElementById("queueList");
    list.innerHTML = "";
    try{
      const rows = await api(`/api/queue?rag=${encodeURIComponent(rag)}`);
      if(!rows?.length){ list.innerHTML = `<div class="item small">No items</div>`; return; }
      for(const e of rows){
        const div=document.createElement("div"); div.className="item";
        div.innerHTML = `
          <div class="item-title">Encounter #${e.id} <span class="badge">${rag}</span></div>
          <div class="small">person_id=${e.person_id} - camp_id=${e.camp_id ?? "-"}</div>
          <div class="small">status=${e.status}</div>
        `;
        list.appendChild(div);
      }
    }catch(err){ list.innerHTML = `<div class="item">Error: ${err.message}</div>`; }
  };

  document.getElementById("loadUnverifiedBtn").onclick = async () => {
    const list = document.getElementById("unvList");
    list.innerHTML = "";
    try{
      const rows = await api(`/api/encounters/unverified`);
      if(!rows?.length){ list.innerHTML = `<div class="item small">No unverified encounters</div>`; return; }
      for(const e of rows){
        const div=document.createElement("div"); div.className="item";
        div.innerHTML = `
          <div class="item-title">Encounter #${e.id} <span class="badge">UNVERIFIED</span></div>
          <div class="small">person_id=${e.person_id} - camp_id=${e.camp_id ?? "-"}</div>
          <div class="actions">
            <button class="btn secondary" data-reject="${e.id}">Reject</button>
            <button class="btn" data-approve="${e.id}">Approve</button>
          </div>
        `;
        list.appendChild(div);
      }

      list.querySelectorAll("button[data-approve]").forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute("data-approve");
          btn.disabled=true;
          try{ await api(`/api/encounters/${id}/approve`, {method:"POST"}); btn.textContent="Approved"; }
          catch(e){ btn.disabled=false; alert(e.message); }
        };
      });
      list.querySelectorAll("button[data-reject]").forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute("data-reject");
          const reason = prompt("Reject reason?") || "";
          btn.disabled=true;
          try{
            await api(`/api/encounters/${id}/reject`, {method:"POST", body: {reason}});
            btn.textContent="Rejected";
          } catch(e){ btn.disabled=false; alert(e.message); }
        };
      });

    }catch(err){ list.innerHTML = `<div class="item">Error: ${err.message}</div>`; }
  };

  requireAuth(); loadMe();
</script>
</body>
</html>
