<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin | RuralReach</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/assets/styles.css">
  <meta name="theme-color" content="#ffffff">
</head>
<body>
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="brand-mark"></div>
      <div>
        <h1>Program Admin</h1>
        <div class="subtitle" id="meLine">Checking session...</div>
      </div>
    </div>
    <div class="row" style="gap:8px">
      <span class="badge" id="netPill">...</span>
      <a class="btn ghost" href="/login.html">Back</a>
      <button class="btn secondary" id="logoutBtn">Logout</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="grid grid-2">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Create camp / clinic session</h2>
      </div>
      <div class="row">
        <input id="campVillageId" placeholder="village_id (number)" />
        <input id="campName" placeholder="name" />
      </div>
      <div class="row">
        <input id="campDate" placeholder="date YYYY-MM-DD" />
        <input id="campStart" placeholder="start_time HH:MM" />
      </div>
      <div class="row">
        <input id="campEnd" placeholder="end_time HH:MM" />
        <input id="campContactName" placeholder="contact_name" />
      </div>
      <div class="row">
        <input id="campContactPhone" placeholder="contact_phone" />
        <input id="campLandmark" placeholder="landmark" />
      </div>
      <textarea id="campAddress" placeholder="address"></textarea>

      <div class="row">
        <input id="campLat" placeholder="lat (required)" />
        <input id="campLng" placeholder="lng (required)" />
      </div>

      <div class="actions">
        <button class="btn secondary" id="getGeoBtn">Capture coordinates</button>
      </div>

      <textarea id="servicesJson" placeholder='services_json checklist (JSON) e.g. ["bp","glucose","hb"]'></textarea>

      <div class="actions">
        <button id="createCampBtn" class="btn">Save camp</button>
      </div>
      <div class="small" id="campMsg"></div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Create staff account</h2>
      </div>
      <div class="row">
        <input id="staffUsername" placeholder="username" />
        <input id="staffPassword" placeholder="password" type="password" />
      </div>
      <div class="row">
        <select id="staffRole">
          <option value="ENUMERATOR">ENUMERATOR</option>
          <option value="SCREENER">SCREENER</option>
          <option value="CLINICIAN">CLINICIAN</option>
          <option value="ADMIN">ADMIN</option>
        </select>
        <input id="staffDisplayName" placeholder="display_name" />
      </div>
      <div class="row">
        <input id="staffPhone" placeholder="phone (optional)" />
        <input id="staffVillages" placeholder="assigned_villages (comma list e.g. 1,2)" />
      </div>
      <div class="actions">
        <button id="createStaffBtn" class="btn">Create staff</button>
      </div>
      <div class="small" id="staffMsg"></div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Create patient account</h2>
      </div>
      <div class="row">
        <input id="patientHouseholdId" placeholder="household_id (number)" />
        <input id="patientVillageId" placeholder="village_id (number)" />
      </div>
      <div class="row">
        <input id="patientName" placeholder="full_name" />
        <input id="patientPhone" placeholder="phone (optional)" />
      </div>
      <div class="row">
        <input id="patientDob" placeholder="dob YYYY-MM-DD (optional)" />
        <select id="patientSex">
          <option value="">sex (optional)</option>
          <option value="M">M</option>
          <option value="F">F</option>
          <option value="O">O</option>
        </select>
      </div>
      <div class="actions">
        <button id="createPatientBtn" class="btn">Create patient</button>
      </div>
      <div class="small">Patient login: username = person_id, password = phone last4</div>
      <div class="small" id="patientMsg"></div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Dashboard quick checks</h2>
      </div>
      <div class="row">
        <button class="btn secondary" id="covBtn">Coverage</button>
        <button class="btn secondary" id="verBtn">Verification rates</button>
      </div>
      <div class="row">
        <button class="btn secondary" id="overBtn">Overdue</button>
        <button class="btn secondary" id="expBtn">Export CSV</button>
      </div>
      <div class="list" id="dashOut"></div>
    </div>
  </div>
</div>

<script type="module">
  import "./js/app.js";
  import { api } from "./js/api.js";
  import { getToken, clearToken } from "./js/auth.js";

  const API_BASE = "http://127.0.0.1:8000";

  function setNetPill(){
    document.getElementById("netPill").textContent = navigator.onLine ? "Online" : "Offline";
  }
  addEventListener("online", setNetPill);
  addEventListener("offline", setNetPill);
  setNetPill();

  function requireAuth(){ if(!getToken()) location.href="/login.html"; }
  async function loadMe(){
    try{
      const me = await api("/api/me");
      const name = me.display_name || (me.worker_id ? `Worker ${me.worker_id}` : me.person_id ? `Person ${me.person_id}` : "User");
      document.getElementById("meLine").textContent = `${me.role} - ${name}`;
    }
    catch{ document.getElementById("meLine").textContent="Session invalid - please login"; }
  }
  document.getElementById("logoutBtn").onclick=()=>{ clearToken(); location.href="/login.html"; };

  document.getElementById("getGeoBtn").onclick = () => {
    if (!navigator.geolocation) { alert("Geolocation not supported"); return; }
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        document.getElementById("campLat").value = pos.coords.latitude.toFixed(6);
        document.getElementById("campLng").value = pos.coords.longitude.toFixed(6);
      },
      (err) => alert("Geolocation error: " + err.message),
      { enableHighAccuracy: true, timeout: 12000 }
    );
  };

  document.getElementById("createCampBtn").onclick = async () => {
    const msg = document.getElementById("campMsg");
    msg.textContent = "Saving...";
    try{
      let services = [];
      const raw = document.getElementById("servicesJson").value.trim();
      if (raw) services = JSON.parse(raw);

      const payload = {
        village_id: Number(document.getElementById("campVillageId").value),
        name: document.getElementById("campName").value.trim(),
        date: document.getElementById("campDate").value.trim(),
        start_time: document.getElementById("campStart").value.trim(),
        end_time: document.getElementById("campEnd").value.trim(),
        address: document.getElementById("campAddress").value.trim(),
        landmark: document.getElementById("campLandmark").value.trim() || null,
        lat: Number(document.getElementById("campLat").value),
        lng: Number(document.getElementById("campLng").value),
        contact_name: document.getElementById("campContactName").value.trim(),
        contact_phone: document.getElementById("campContactPhone").value.trim(),
        services_json: services
      };
      const out = await api("/api/camps", { method:"POST", body: payload });
      msg.textContent = `Saved camp id=${out.id ?? "OK"}`;
    } catch(e) {
      msg.textContent = `Error: ${e.message}`;
    }
  };

  document.getElementById("createStaffBtn").onclick = async () => {
    const msg = document.getElementById("staffMsg");
    msg.textContent = "Saving...";
    try {
      const rawVillages = document.getElementById("staffVillages").value.trim();
      const assigned_villages = rawVillages
        ? rawVillages.split(",").map(v => Number(v.trim())).filter(v => !Number.isNaN(v))
        : [];
      const payload = {
        username: document.getElementById("staffUsername").value.trim(),
        password: document.getElementById("staffPassword").value.trim(),
        role: document.getElementById("staffRole").value,
        display_name: document.getElementById("staffDisplayName").value.trim() || null,
        phone: document.getElementById("staffPhone").value.trim() || null,
        assigned_villages
      };
      const out = await api("/api/admin/workers", { method: "POST", body: payload });
      msg.textContent = `Created staff id=${out.id ?? "OK"}`;
    } catch (e) {
      msg.textContent = `Error: ${e.message}`;
    }
  };

  document.getElementById("createPatientBtn").onclick = async () => {
    const msg = document.getElementById("patientMsg");
    msg.textContent = "Saving...";
    try {
      const payload = {
        household_id: Number(document.getElementById("patientHouseholdId").value),
        village_id: Number(document.getElementById("patientVillageId").value),
        full_name: document.getElementById("patientName").value.trim(),
        phone: document.getElementById("patientPhone").value.trim() || null,
        dob: document.getElementById("patientDob").value.trim() || null,
        sex: document.getElementById("patientSex").value || null,
        demographics_json: null,
        risk_survey_json: null
      };
      const out = await api("/api/admin/patients", { method: "POST", body: payload });
      msg.textContent = `Created patient id=${out.id ?? "OK"} (login uses id + phone last4)`;
    } catch (e) {
      msg.textContent = `Error: ${e.message}`;
    }
  };

  function show(obj){
    const out = document.getElementById("dashOut");
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML = `<pre>${JSON.stringify(obj,null,2)}</pre>`;
    out.prepend(div);
  }

  document.getElementById("covBtn").onclick = async ()=>{ try{ show(await api("/api/dashboard/coverage")); }catch(e){ alert(e.message); } };
  document.getElementById("overBtn").onclick = async ()=>{ try{ show(await api("/api/dashboard/overdue")); }catch(e){ alert(e.message); } };
  document.getElementById("verBtn").onclick = async ()=>{ try{ show(await api("/api/dashboard/verification-rates")); }catch(e){ alert(e.message); } };
  document.getElementById("expBtn").onclick = async ()=>{
    try{
      const token = getToken();
      const res = await fetch(API_BASE + "/api/export/csv", { headers: { Authorization: "Bearer " + token } });
      if(!res.ok) throw new Error(await res.text());
      const csv = await res.text();
      show({csv_preview: csv.slice(0, 2000)});
    } catch(e){ alert(e.message); }
  };

  requireAuth(); loadMe();
</script>
</body>
</html>
