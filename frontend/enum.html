<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Enumerator | Rural Health</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/assets/styles.css">
  <meta name="theme-color" content="#0b1320">
</head>
<body class="page page-enum">
<header>
  <div class="header-main">
    <div>
      <div class="page-title"><span class="dot"></span><h1>Enumerator</h1></div>
      <div class="subtitle" id="meLine">Checking session...</div>
    </div>
    <div class="header-actions">
      <span class="pill" id="netPill">...</span>
      <a class="btn ghost" href="/login.html">Back</a>
      <button class="secondary btn-inline" id="logoutBtn">Logout</button>
    </div>
  </div>
</header>

<main class="stack">
  <div class="card">
    <h2>Search people</h2>
    <div class="row">
      <input id="q" placeholder="Search name / phone / id" />
      <button id="searchBtn">Search</button>
    </div>
    <div class="muted mt-8">Tip: works even on low bandwidth. If offline, it will show last cached results (if you implement caching later).</div>
    <div class="list mt-10" id="peopleList"></div>
  </div>

  <div class="card">
    <h2>Create household</h2>
    <div class="row">
      <input id="hhVillageId" placeholder="village_id (number)" />
      <input id="hhHead" placeholder="head_name" />
    </div>
    <div class="row">
      <input id="hhHamlet" placeholder="hamlet (optional)" />
      <input id="hhPhone" placeholder="phone (optional)" />
    </div>
    <button id="createHouseholdBtn">Save household</button>
    <div class="muted mt-8" id="hhMsg"></div>
  </div>

  <div class="card">
    <h2>Create person</h2>
    <div class="row">
      <input id="personHouseholdId" placeholder="household_id (number)" />
      <input id="personName" placeholder="full_name" />
    </div>
    <div class="row">
      <input id="personDob" placeholder="dob YYYY-MM-DD (optional)" />
      <select id="personSex">
        <option value="">sex (optional)</option>
        <option value="M">M</option>
        <option value="F">F</option>
        <option value="O">O</option>
      </select>
    </div>
    <div class="row">
      <input id="personPhone" placeholder="phone" />
      <input id="personVillageId" placeholder="village_id (number)" />
    </div>
    <textarea id="personRiskJson" placeholder='risk_survey_json (optional JSON) e.g. {"tobacco":true}'></textarea>
    <button id="createPersonBtn">Save person</button>
    <div class="muted mt-8" id="pMsg"></div>
  </div>

  <div class="card">
    <h2>Camps (assigned village)</h2>
    <div class="row">
      <input id="campVillageId" placeholder="village_id (number)" />
      <button id="loadCampsBtn">Load camps</button>
    </div>
    <div class="list mt-10" id="campsList"></div>
  </div>
</main>

<script type="module">
  import "./js/app.js";
  import { api } from "./js/api.js";
  import { getToken, clearToken } from "./js/auth.js";

  function setNetPill() {
    const el = document.getElementById("netPill");
    el.textContent = navigator.onLine ? "Online" : "Offline";
  }
  window.addEventListener("online", setNetPill);
  window.addEventListener("offline", setNetPill);
  setNetPill();

  function requireAuth() {
    if (!getToken()) location.href = "/login.html";
  }

  async function loadMe() {
    try {
      const me = await api("/api/me");
      const name = me.display_name || (me.worker_id ? `Worker ${me.worker_id}` : me.person_id ? `Person ${me.person_id}` : "User");
      document.getElementById("meLine").textContent = `${me.role} - ${name}`;
    } catch (e) {
      document.getElementById("meLine").textContent = "Session invalid - please login";
    }
  }

  document.getElementById("logoutBtn").onclick = () => {
    clearToken();
    location.href = "/login.html";
  };

  // Search people
  document.getElementById("searchBtn").onclick = async () => {
    const q = document.getElementById("q").value.trim();
    const list = document.getElementById("peopleList");
    list.innerHTML = "";
    try {
      const rows = await api(`/api/people?search=${encodeURIComponent(q)}&updated_since=`);
      if (!rows?.length) {
        list.innerHTML = `<div class="item muted">No results</div>`;
        return;
      }
      for (const p of rows) {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="item-title">${p.full_name ?? p.name ?? ("Person #" + p.id)}</div>
          <div class="muted">id=${p.id} - phone=${p.phone ?? "-"} - village_id=${p.village_id ?? "-"}</div>
        `;
        list.appendChild(div);
      }
    } catch (e) {
      list.innerHTML = `<div class="item">Error: ${e.message}</div>`;
    }
  };

  // Create household
  document.getElementById("createHouseholdBtn").onclick = async () => {
    const msg = document.getElementById("hhMsg");
    msg.textContent = "Saving...";
    try {
      const payload = {
        village_id: Number(document.getElementById("hhVillageId").value),
        head_name: document.getElementById("hhHead").value.trim(),
        hamlet: document.getElementById("hhHamlet").value.trim() || null,
        phone: document.getElementById("hhPhone").value.trim() || null,
      };
      const out = await api("/api/households", { method: "POST", body: payload });
      msg.textContent = `Saved household id=${out.id ?? "OK"}`;
    } catch (e) {
      msg.textContent = `Error: ${e.message}`;
    }
  };

  // Create person
  document.getElementById("createPersonBtn").onclick = async () => {
    const msg = document.getElementById("pMsg");
    msg.textContent = "Saving...";
    try {
      let risk = null;
      const riskRaw = document.getElementById("personRiskJson").value.trim();
      if (riskRaw) risk = JSON.parse(riskRaw);

      const payload = {
        household_id: Number(document.getElementById("personHouseholdId").value),
        full_name: document.getElementById("personName").value.trim(),
        phone: document.getElementById("personPhone").value.trim(),
        village_id: Number(document.getElementById("personVillageId").value),
        dob: document.getElementById("personDob").value.trim() || null,
        sex: document.getElementById("personSex").value || null,
        risk_survey_json: risk,
      };
      const out = await api("/api/people", { method: "POST", body: payload });
      msg.textContent = `Saved person id=${out.id ?? "OK"}`;
    } catch (e) {
      msg.textContent = `Error: ${e.message}`;
    }
  };

  // Camps list
  document.getElementById("loadCampsBtn").onclick = async () => {
    const villageId = document.getElementById("campVillageId").value.trim();
    const list = document.getElementById("campsList");
    list.innerHTML = "";
    try {
      const rows = await api(`/api/camps?village_id=${encodeURIComponent(villageId)}&from_date=&updated_since=`);
      if (!rows?.length) {
        list.innerHTML = `<div class="item muted">No camps</div>`;
        return;
      }
      for (const c of rows) {
        const maps = `https://www.google.com/maps?q=${c.lat},${c.lng}`;
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="item-title">${c.name}</div>
          <div class="muted">${c.date} - ${c.start_time}-${c.end_time}</div>
          <div class="muted">${c.address ?? ""} ${c.landmark ? "- " + c.landmark : ""}</div>
          <div class="actions">
            <a class="pill" href="${maps}" target="_blank" rel="noreferrer">Open in Maps</a>
            <span class="pill">Phone: ${c.contact_phone ?? "-"}</span>
          </div>
        `;
        list.appendChild(div);
      }
    } catch (e) {
      list.innerHTML = `<div class="item">Error: ${e.message}</div>`;
    }
  };

  requireAuth();
  loadMe();
</script>
</body>
</html>
